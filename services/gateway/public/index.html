<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8/">
        <title>BookBooker</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            body { font-family: ui-sans-serif, system-ui, Arial, sans-serif; margin: 24px; max-width: 900px;}
            input, button {padding: 8px; font-size: 16px;}
            .row { display: flex; gap: 8px; align-items: center; }
            .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
            .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
            h2 {margin: 16px 0 8px; }
            code  {background: #f4f4f4; padding: 2px 4px; border-radius: 4px; }
            ul { padding-left: 20px; }
        </style>
    </head>
    <body>
        <h1> BookBooker </h1>

        <div class="row">
            <input id="q" placeholder="Search books (e.g. Tolkien)" style="flex:1"/>
            <button id="go">Search</button>
        </div>

        <div class="cols">
            <div class="card">
                <div id="results">-</div>
            </div>
            <div class="card">
                <h2>Definition</h2>
                <div id="def">-</div>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <h2>Favorites</h2>
            <button id="reloadFavs">Reload</button>
            <div id="favs">-</div>
        </div>

        <script>
            async function api(path, opts) {
                const r = await fetch(path, opts);
                if (!r.ok) throw new Error(await r.text());
                return r.json();
            }


            function el(tag, attrs={}, ...children){
                const e = document.createElement(tag);
                Object.entries(attrs).forEach(([k,v]) => e.SetAttribute(k,v));
                children.forEach(c => e.append(typeof c==='string'?document.createTextNode(c):c));
                return e;
            }

            async function search() {
                const q = document.getElementById('q').value.trim();
                if (!q) return;
                document.getElementById('results').textContent = "Searching...";
                document.getElementById('def').textContent = 'Loading...';
                try {
                    const data = await api('/api/search?q='+encodeURIComponent(q));
                    // Books 
                    const redDiv = el('div');
                    (data.books||[]).forEach(b => {
                        const line = el('div', {},
                            el('strong',{}, b.title || 'untitled'),
                            ' - ',
                            (b.author || 'unknown'),
                            b.year ? ` (${b.year})` : ''
                        );
                        const btn = el('button', {style:'margin-left:8px'});
                        btn.textContent = ' Save';
      btn.onclick = async () => {
        await api('/api/favorites', {method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title: b.title, author: b.author, year: b.year })
        });
        await loadFavs();
      };
      line.append(btn);
      resDiv.append(line);
    });
    document.getElementById('results').replaceChildren(resDiv);
    // Definition
    const def = (data.definition||[]).length ? el('ul',{}, ...(data.definition||[]).map(d => el('li',{}, d))) : '–';
    document.getElementById('def').replaceChildren(def);
  } catch (e) {
    document.getElementById('results').textContent = 'Error';
    document.getElementById('def').textContent = 'Error';
  }
}

async function loadFavs(){
  const favs = await api('/api/favorites');
  const wrap = el('div');
  favs.forEach(f => {
    const row = el('div',{}, 
      `${f.title} — ${f.author||'unknown'} ${f.year? '('+f.year+')':''} `,
    );
    const del = el('button',{style:'margin-left:8px'}); del.textContent='Delete';
    del.onclick = async ()=>{ await api('/api/favorites/'+f._id, {method:'DELETE'}); await loadFavs(); };
    row.append(del);
    wrap.append(row);
  });
  document.getElementById('favs').replaceChildren(wrap);
}

document.getElementById('go').onclick = search;
document.getElementById('reloadFavs').onclick = loadFavs;
loadFavs();
        </script>
    </body>
</html>